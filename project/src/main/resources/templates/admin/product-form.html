<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title th:text="${product.id != null ? 'Edit Product' : 'Add Product'}">Product Form</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" th:href="@{/admin/dashboard}">Admin Panel</a>
        <div class="navbar-nav ms-auto">
          <a class="nav-link" th:href="@{/admin/products}">Back to Products</a>
          <a class="nav-link" th:href="@{/}">Home</a>
        </div>
      </div>
    </nav>

    <div class="container mt-5">
      <h1 th:text="${product.id != null ? 'Edit Product' : 'Add New Product'}">Product Form</h1>

      <form th:action="@{/admin/products/save}" th:object="${product}" method="post" enctype="multipart/form-data" class="mt-4" id="productForm">
        <input type="hidden" th:field="*{id}" />

        <div class="mb-3">
          <label for="name" class="form-label">Name *</label>
          <input type="text" class="form-control" id="name" th:field="*{name}" required />
        </div>

        <div class="mb-3">
          <label for="price" class="form-label">Price *</label>
          <input type="number" class="form-control" id="price" th:field="*{price}" step="0.01" min="0" required />
        </div>

        <div class="mb-3">
          <label for="imageFile" class="form-label">Upload Product Image from Computer <span th:if="${product.id == null}">*</span></label>
          <input type="file" class="form-control" id="imageFile" name="imageFile" accept="image/*" th:required="${product.id == null}" />
          <small class="form-text text-muted">
            <strong>üì§ Upload an image file from your computer (JPG, PNG, GIF, etc.)</strong><br/>
            The image will be <strong>automatically saved to the images folder</strong> and the path will be <strong>saved to MySQL database</strong>.
          </small>
          <div th:if="${product.id != null && product.imageUrl != null}" class="mt-2">
            <p class="text-muted">Current image:</p>
            <img th:src="@{'/' + ${product.imageUrl}}" alt="Current product image" style="max-width: 200px; max-height: 200px;" class="img-thumbnail" />
            <p class="text-muted small mt-1">Upload a new image to replace the current one, or leave empty to keep current image</p>
          </div>
        </div>

        <div class="mb-3">
          <label for="imageUrl" class="form-label">Or enter Image URL manually <span th:if="${product.id == null}">*</span></label>
          <input type="text" class="form-control" id="imageUrl" th:field="*{imageUrl}" placeholder="e.g., images/product-1.jpg" />
          <small class="form-text text-muted">
            <strong>Only use this if you have an existing image URL.</strong><br/>
            If you upload a file above, this field will be automatically filled by the system.
          </small>
        </div>
        
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
          <span th:text="${error}"></span>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div class="mb-3">
          <label for="description" class="form-label">Description</label>
          <textarea class="form-control" id="description" th:field="*{description}" rows="3"></textarea>
        </div>

        <div class="mb-3">
          <label for="category" class="form-label">Category *</label>
          <select class="form-control" id="category" th:field="*{category}" required>
            <option value="">Select Category</option>
            <option value="clothes">Clothes</option>
            <option value="accessories">Accessories</option>
          </select>
        </div>

        <div class="mb-3">
          <label for="stockQuantity" class="form-label">Stock Quantity *</label>
          <input type="number" class="form-control" id="stockQuantity" th:field="*{stockQuantity}" min="0" required />
        </div>

        <div class="mb-3">
          <label for="rating" class="form-label">Rating</label>
          <input type="number" class="form-control" id="rating" th:field="*{rating}" step="0.1" min="0" max="5" />
        </div>

        <div class="mb-3">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="isNewArrival" th:field="*{newArrival}" />
            <label class="form-check-label" for="isNewArrival">New Arrival</label>
          </div>
        </div>

        <div class="mb-3">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="isBestSeller" th:field="*{bestSeller}" />
            <label class="form-check-label" for="isBestSeller">Best Seller</label>
          </div>
        </div>

        <div class="mb-3">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="isLimitedEdition" th:field="*{limitedEdition}" />
            <label class="form-check-label" for="isLimitedEdition">Limited Edition</label>
          </div>
        </div>

        <div class="mb-3">
          <label for="material" class="form-label">Material</label>
          <input type="text" class="form-control" id="material" th:field="*{material}" />
        </div>

        <div class="mb-3">
          <label for="color" class="form-label">Color</label>
          <input type="text" class="form-control" id="color" th:field="*{color}" />
        </div>

        <div class="mb-3">
          <label for="availableSizes" class="form-label">Available Sizes</label>
          <input type="text" class="form-control" id="availableSizes" th:field="*{availableSizes}" placeholder="e.g., S,M,L,XL" />
        </div>

        <div class="mb-3">
          <label for="season" class="form-label">Season</label>
          <select class="form-control" id="season" th:field="*{season}">
            <option value="">Select Season</option>
            <option value="Spring">Spring</option>
            <option value="Summer">Summer</option>
            <option value="Autumn">Autumn</option>
            <option value="Winter">Winter</option>
            <option value="All">All</option>
          </select>
        </div>

        <button type="submit" class="btn btn-primary">Save Product</button>
        <a th:href="@{/admin/products}" class="btn btn-secondary">Cancel</a>
      </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Auto-fill imageUrl when file is selected (for preview, but server will handle the actual path)
      document.getElementById('imageFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          console.log('File selected:', file.name);
          console.log('File size:', file.size, 'bytes');
          console.log('File type:', file.type);
          
          // Show preview
          const reader = new FileReader();
          reader.onload = function(e) {
            // You can show a preview here if needed
            console.log('File ready for upload');
          };
          reader.readAsDataURL(file);
        }
      });
      
      // Debug form submission
      document.getElementById('productForm').addEventListener('submit', function(e) {
        const imageFile = document.getElementById('imageFile');
        const imageUrl = document.getElementById('imageUrl');
        const productId = document.querySelector('input[name="id"]').value;
        
        console.log('=== FORM SUBMISSION DEBUG ===');
        console.log('Product ID:', productId || 'NEW PRODUCT');
        console.log('ImageFile selected:', imageFile.files.length > 0 ? imageFile.files[0].name : 'No file');
        console.log('ImageUrl value:', imageUrl.value);
        
        // Validate for new products
        if (!productId && !imageFile.files.length && !imageUrl.value.trim()) {
          alert('‚ö†Ô∏è Please upload an image file from your computer!\n\nThe image will be automatically saved to the images folder and the path will be saved to the database.');
          e.preventDefault();
          return false;
        }
        
        if (imageFile.files.length > 0) {
          const file = imageFile.files[0];
          if (file.size > 10 * 1024 * 1024) {
            alert('‚ö†Ô∏è Image file is too large! Maximum size is 10MB.');
            e.preventDefault();
            return false;
          }
          console.log('‚úÖ File validation passed. Submitting form...');
        }
      });
    </script>
  </body>
</html>

